<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estado de juicios por programa</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      margin: 0;
      background: #f3f4f6;
      color: #1f2933;
    }

    header {
      background: linear-gradient(135deg, #168a45, #0b5d28);
      color: #fff;
      padding: 2.75rem 1.5rem 2rem;
      box-shadow: 0 18px 40px -25px rgba(12, 68, 30, 0.9);
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 3vw, 2.5rem);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      margin-top: 0.75rem;
      max-width: 52rem;
      font-size: 1.02rem;
      color: rgba(255, 255, 255, 0.88);
    }

    main {
      max-width: 1100px;
      margin: -1.75rem auto 3.5rem;
      padding: 0 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
    }

    .status {
      background: #fff;
      border-left: 6px solid #168a45;
      border-radius: 0.9rem;
      padding: 1.35rem 1.6rem;
      box-shadow: 0 22px 45px -32px rgba(15, 60, 30, 0.6);
      font-size: 1rem;
    }

    .status.error {
      border-color: #dc2626;
      background: #fee2e2;
      color: #7f1d1d;
      box-shadow: 0 18px 40px -32px rgba(185, 28, 28, 0.7);
    }

    .status.hidden {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    .summary {
      background: #fff;
      border-radius: 0.9rem;
      padding: 1.1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      box-shadow: 0 18px 35px -30px rgba(15, 60, 30, 0.45);
      border: 1px solid rgba(22, 138, 69, 0.1);
    }

    .summary strong {
      font-size: 1.05rem;
      color: #0b5d28;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.85rem;
      font-size: 0.92rem;
      color: #475467;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .legend .dot {
      width: 0.8rem;
      height: 0.8rem;
      border-radius: 50%;
      display: inline-block;
    }

    .dot.pending {
      background: #dc2626;
    }

    .dot.resolved {
      background: #16a34a;
    }

    .program-list {
      display: grid;
      gap: 1.5rem;
    }

    .program-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.6rem;
      box-shadow: 0 24px 48px -34px rgba(15, 60, 30, 0.6);
      border: 1px solid rgba(22, 138, 69, 0.12);
      display: flex;
      flex-direction: column;
      gap: 1.15rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .program-card.has-pending {
      border-color: rgba(220, 38, 38, 0.35);
      box-shadow: 0 28px 60px -30px rgba(220, 38, 38, 0.45);
    }

    .program-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 26px 55px -32px rgba(15, 60, 30, 0.55);
    }

    .program-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.85rem 1.5rem;
    }

    .program-name {
      margin: 0;
      font-size: clamp(1.4rem, 2.5vw, 1.9rem);
      color: #0b5d28;
      font-weight: 680;
      letter-spacing: 0.01em;
    }

    .program-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.96rem;
      color: #475467;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.32rem 0.9rem;
      border-radius: 9999px;
      background: rgba(22, 138, 69, 0.12);
      color: #14532d;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .badge.secondary {
      background: rgba(14, 165, 233, 0.15);
      color: #0c4a6e;
    }

    .badge.success {
      background: rgba(22, 163, 74, 0.18);
      color: #0f5132;
    }

    .badge.danger {
      background: rgba(220, 38, 38, 0.18);
      color: #7f1d1d;
    }

    .fiche-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .fiche-list li {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      background: #f1f5f9;
      color: #0f172a;
      padding: 0.45rem 1rem;
      border-radius: 9999px;
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      letter-spacing: 0.04em;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
    }

    .fiche-list li.pending {
      background: rgba(220, 38, 38, 0.12);
      color: #7f1d1d;
      box-shadow: none;
      border: 1px solid rgba(220, 38, 38, 0.3);
    }

    .fiche-list li.resolved {
      background: rgba(22, 163, 74, 0.12);
      color: #0f5132;
      border: 1px solid rgba(22, 163, 74, 0.3);
      box-shadow: none;
    }

    .empty-message {
      margin: 0;
      font-size: 0.96rem;
      color: #6b7280;
      font-style: italic;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #0f172a;
        color: #e2e8f0;
      }

      header {
        box-shadow: none;
      }

      header p {
        color: rgba(226, 232, 240, 0.75);
      }

      .status {
        background: #111827;
        color: #e2e8f0;
        border-color: #34d399;
        box-shadow: 0 22px 40px -28px rgba(15, 118, 110, 0.7);
      }

      .status.error {
        border-color: #f87171;
        background: rgba(127, 29, 29, 0.35);
        color: #fecaca;
      }

      .summary {
        background: #111827;
        border-color: rgba(59, 130, 246, 0.12);
        box-shadow: 0 20px 40px -28px rgba(59, 130, 246, 0.4);
      }

      .summary strong {
        color: #34d399;
      }

      .legend {
        color: #cbd5f5;
      }

      .legend .dot.pending {
        background: #f87171;
      }

      .legend .dot.resolved {
        background: #4ade80;
      }

      .program-card {
        background: #111827;
        border-color: rgba(59, 130, 246, 0.12);
        box-shadow: 0 28px 60px -32px rgba(59, 130, 246, 0.4);
      }

      .program-card.has-pending {
        border-color: rgba(248, 113, 113, 0.45);
        box-shadow: 0 30px 65px -34px rgba(248, 113, 113, 0.5);
      }

      .program-name {
        color: #34d399;
      }

      .program-meta {
        color: #cbd5f5;
      }

      .badge {
        background: rgba(22, 163, 74, 0.25);
        color: #bbf7d0;
      }

      .badge.secondary {
        background: rgba(59, 130, 246, 0.25);
        color: #bfdbfe;
      }

      .badge.success {
        background: rgba(22, 163, 74, 0.35);
        color: #bbf7d0;
      }

      .badge.danger {
        background: rgba(248, 113, 113, 0.35);
        color: #fee2e2;
      }

      .fiche-list li {
        background: rgba(148, 163, 184, 0.18);
        color: #f8fafc;
        box-shadow: none;
      }

      .fiche-list li.pending {
        background: rgba(248, 113, 113, 0.25);
        color: #fee2e2;
      }

      .fiche-list li.resolved {
        background: rgba(74, 222, 128, 0.25);
        color: #dcfce7;
      }

      .empty-message {
        color: #94a3b8;
      }
    }

    @media (max-width: 780px) {
      header {
        padding: 2.4rem 1.2rem 1.8rem;
      }

      main {
        margin-top: -1.2rem;
        padding: 0 1.2rem 2.5rem;
      }

      .program-card {
        padding: 1.35rem;
      }

      .program-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Estado de juicios de evaluación</h1>
    <p>Identifica rápidamente qué programas de formación tienen fichas con juicios de evaluación pendientes por calificar y cuáles ya están al día.</p>
  </header>
  <main>
    <section id="status" class="status">Cargando información…</section>
    <section id="summary" class="summary hidden"></section>
    <div class="legend">
      <span><span class="dot pending"></span>Juicio pendiente de calificar</span>
      <span><span class="dot resolved"></span>Juicio calificado</span>
    </div>
    <div id="programList" class="program-list"></div>
  </main>

  <script>
    const statusElement = document.getElementById("status");
    const programList = document.getElementById("programList");
    const summaryElement = document.getElementById("summary");

    function showStatus(message, type = "info") {
      statusElement.textContent = message;
      statusElement.classList.remove("hidden", "error");
      if (type === "error") {
        statusElement.classList.add("error");
      }
    }

    function hideStatus() {
      statusElement.classList.add("hidden");
    }

    function showSummary({ totalPrograms, totalFiches, totalPending, programsWithPending }) {
      summaryElement.innerHTML = `
        <strong>Resumen general</strong>
        <div>Programas activos: <strong>${totalPrograms}</strong></div>
        <div>Fichas registradas: <strong>${totalFiches}</strong></div>
        <div>Fichas con juicios pendientes: <strong>${totalPending}</strong></div>
        <div>Programas con algún pendiente: <strong>${programsWithPending}</strong></div>
      `;
      summaryElement.classList.remove("hidden");
    }

    function renderPrograms(programs) {
      programList.innerHTML = "";
      if (!programs.length) {
        const empty = document.createElement("p");
        empty.className = "empty-message";
        empty.textContent = "No hay programas con fichas registradas en este momento.";
        programList.appendChild(empty);
        return;
      }

      for (const program of programs) {
        programList.appendChild(createProgramCard(program));
      }
    }

    function createProgramCard(program) {
      const card = document.createElement("article");
      card.className = "program-card";
      if (program.pendingCount > 0) {
        card.classList.add("has-pending");
      }

      const header = document.createElement("div");
      header.className = "program-header";

      const name = document.createElement("h2");
      name.className = "program-name";
      name.textContent = program.name || "Programa sin nombre";

      const meta = document.createElement("div");
      meta.className = "program-meta";

      const codeBadge = document.createElement("span");
      codeBadge.className = "badge";
      codeBadge.textContent = program.code ? `Código ${program.code}` : "Código no disponible";
      meta.appendChild(codeBadge);

      const versionBadge = document.createElement("span");
      versionBadge.className = "badge secondary";
      versionBadge.textContent = program.version ? `Versión ${program.version}` : "Versión sin registrar";
      meta.appendChild(versionBadge);

      const countBadge = document.createElement("span");
      countBadge.className = "badge";
      countBadge.textContent = program.ficheEntries.length === 1
        ? "1 ficha registrada"
        : `${program.ficheEntries.length} fichas registradas`;
      meta.appendChild(countBadge);

      const pendingBadge = document.createElement("span");
      pendingBadge.className = `badge ${program.pendingCount > 0 ? "danger" : "success"}`;
      pendingBadge.textContent = program.pendingCount > 0
        ? `${program.pendingCount} ficha(s) con juicio pendiente`
        : "Sin juicios pendientes";
      meta.appendChild(pendingBadge);

      header.appendChild(name);
      header.appendChild(meta);
      card.appendChild(header);

      if (program.ficheEntries.length) {
        const list = document.createElement("ul");
        list.className = "fiche-list";
        for (const fiche of program.ficheEntries) {
          const item = document.createElement("li");
          item.classList.add(fiche.pending ? "pending" : "resolved");
          item.textContent = fiche.number;
          list.appendChild(item);
        }
        card.appendChild(list);
      } else {
        const empty = document.createElement("p");
        empty.className = "empty-message";
        empty.textContent = "Este programa aún no tiene fichas asociadas.";
        card.appendChild(empty);
      }

      return card;
    }

    function enrichPrograms(programs, pendingSet) {
      const seenFiches = new Set();
      const enriched = programs.map(program => {
        const ficheEntries = Array.isArray(program.fiches)
          ? program.fiches.map(number => {
              const ficheNumber = String(number).trim();
              const pending = pendingSet.has(ficheNumber);
              seenFiches.add(ficheNumber);
              return { number: ficheNumber, pending };
            })
          : [];

        const pendingCount = ficheEntries.filter(fiche => fiche.pending).length;

        return {
          ...program,
          ficheEntries,
          pendingCount
        };
      });

      return { enriched, seenFiches };
    }

    function buildOrphanCard(orphanFiches) {
      const card = document.createElement("article");
      card.className = "program-card has-pending";

      const name = document.createElement("h2");
      name.className = "program-name";
      name.textContent = "Fichas sin programa asociado";

      const description = document.createElement("p");
      description.className = "empty-message";
      description.textContent = "Estas fichas tienen juicios pendientes, pero no están vinculadas a un programa activo.";

      const list = document.createElement("ul");
      list.className = "fiche-list";

      for (const number of orphanFiches) {
        const item = document.createElement("li");
        item.classList.add("pending");
        item.textContent = number;
        list.appendChild(item);
      }

      card.appendChild(name);
      card.appendChild(description);
      card.appendChild(list);

      return card;
    }

    async function loadData() {
      showStatus("Cargando información…");
      try {
        const [programsRes, pendingRes] = await Promise.all([
          fetch("/programas", { headers: { Accept: "application/json" } }),
          fetch("/pendientes", { headers: { Accept: "application/json" } })
        ]);

        if (!programsRes.ok) {
          throw new Error(`Error al obtener programas: ${programsRes.status}`);
        }
        if (!pendingRes.ok) {
          throw new Error(`Error al obtener pendientes: ${pendingRes.status}`);
        }

        const { programs = [] } = await programsRes.json();
        const { fichas: pendingFiches = [] } = await pendingRes.json();
        const pendingSet = new Set(
          Array.isArray(pendingFiches)
            ? pendingFiches.map(f => String(f).trim())
            : []
        );

        const { enriched, seenFiches } = enrichPrograms(Array.isArray(programs) ? programs : [], pendingSet);

        enriched.sort((a, b) => {
          if (a.pendingCount > 0 && b.pendingCount === 0) return -1;
          if (a.pendingCount === 0 && b.pendingCount > 0) return 1;
          const nameA = (a.name || "").toString();
          const nameB = (b.name || "").toString();
          const nameCompare = nameA.localeCompare(nameB, "es", { sensitivity: "base" });
          if (nameCompare !== 0) return nameCompare;
          return (a.code || "").localeCompare(b.code || "");
        });

        const totalPrograms = enriched.length;
        const totalFiches = enriched.reduce((sum, program) => sum + program.ficheEntries.length, 0);
        const totalPending = enriched.reduce((sum, program) => sum + program.pendingCount, 0);
        const programsWithPending = enriched.filter(program => program.pendingCount > 0).length;

        hideStatus();
        showSummary({ totalPrograms, totalFiches, totalPending, programsWithPending });
        renderPrograms(enriched);

        const orphanFiches = [...pendingSet].filter(fiche => !seenFiches.has(fiche));
        if (orphanFiches.length) {
          programList.prepend(buildOrphanCard(orphanFiches.sort((a, b) => a.localeCompare(b))));
        }
      } catch (error) {
        console.error(error);
        showStatus("No fue posible cargar la información. Intenta nuevamente más tarde.", "error");
      }
    }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>